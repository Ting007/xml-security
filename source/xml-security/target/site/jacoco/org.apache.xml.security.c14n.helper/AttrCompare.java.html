<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AttrCompare.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Ant Example</a> &gt; <a href="index.source.html" class="el_package">org.apache.xml.security.c14n.helper</a> &gt; <span class="el_source">AttrCompare.java</span></div><h1>AttrCompare.java</h1><pre class="source lang-java linenums">
/*
 * The Apache Software License, Version 1.1
 *
 *
 * Copyright (c) 1999 The Apache Software Foundation.  All rights 
 * reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer. 
 *
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in
 *    the documentation and/or other materials provided with the
 *    distribution.
 *
 * 3. The end-user documentation included with the redistribution,
 *    if any, must include the following acknowledgment:  
 *       &quot;This product includes software developed by the
 *        Apache Software Foundation (http://www.apache.org/).&quot;
 *    Alternately, this acknowledgment may appear in the software itself,
 *    if and wherever such third-party acknowledgments normally appear.
 *
 * 4. The names &quot;&lt;WebSig&gt;&quot; and &quot;Apache Software Foundation&quot; must
 *    not be used to endorse or promote products derived from this
 *    software without prior written permission. For written 
 *    permission, please contact apache@apache.org.
 *
 * 5. Products derived from this software may not be called &quot;Apache&quot;,
 *    nor may &quot;Apache&quot; appear in their name, without prior written
 *    permission of the Apache Software Foundation.
 *
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
 * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
 * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
 * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 * ====================================================================
 *
 * This software consists of voluntary contributions made by many
 * individuals on behalf of the Apache Software Foundation and was
 * originally based on software copyright (c) 2001, Institute for
 * Data Communications Systems, &lt;http://www.nue.et-inf.uni-siegen.de/&gt;.
 * The development of this software was partly funded by the European 
 * Commission in the &lt;WebSig&gt; project in the ISIS Programme. 
 * For more information on the Apache Software Foundation, please see
 * &lt;http://www.apache.org/&gt;.
 */
package org.apache.xml.security.c14n.helper;



import org.w3c.dom.*;
import org.apache.log4j.*;
import org.apache.xml.security.c14n.CanonicalizationException;
import org.apache.xml.security.utils.Constants;


/**
 * Compares two attributes based on the C14n specification.
 *
 * &lt;UL&gt;
 * &lt;LI&gt;Namespace nodes have a lesser document order position than attribute nodes.
 * &lt;LI&gt; An element's namespace nodes are sorted lexicographically by
 *   local name (the default namespace node, if one exists, has no
 *   local name and is therefore lexicographically least).
 * &lt;LI&gt; An element's attribute nodes are sorted lexicographically with
 *   namespace URI as the primary key and local name as the secondary
 *   key (an empty namespace URI is lexicographically least).
 * &lt;/UL&gt;
 *
 * @todo Should we implement java.util.Comparator and import java.util.Arrays to use Arrays.sort(intarray);
 * @author Christian Geuer-Pollmann
 */
<span class="fc" id="L86">public class AttrCompare implements java.util.Comparator, sun.misc.Compare {</span>

   /** {@link org.apache.log4j} logging facility */
<span class="fc" id="L89">   static org.apache.log4j.Category cat =</span>
      org.apache.log4j.Category.getInstance(AttrCompare.class.getName());

   /**
    * Same as {@link #compare}.
    * @param obj0
    * @param obj1
    * @return
    */
   public int doCompare(Object obj0, Object obj1) {
<span class="nc" id="L99">      return this.compare(obj0, obj1);</span>
   }

   /**
    * Compares two attributes based on the C14n specification.
    *
    * &lt;UL&gt;
    * &lt;LI&gt;Namespace nodes have a lesser document order position than attribute nodes.
    * &lt;LI&gt; An element's namespace nodes are sorted lexicographically by
    *   local name (the default namespace node, if one exists, has no
    *   local name and is therefore lexicographically least).
    * &lt;LI&gt; An element's attribute nodes are sorted lexicographically with
    *   namespace URI as the primary key and local name as the secondary
    *   key (an empty namespace URI is lexicographically least).
    * &lt;/UL&gt;
    *
    * @param obj0 casted Attr
    * @param obj1 casted Attr
    * @return returns a negative integer, zero, or a positive integer as obj0 is less than, equal to, or greater than obj1
    *
    */
   public int compare(Object obj0, Object obj1) {

<span class="fc" id="L122">      Attr attr0 = (Attr) obj0;</span>
<span class="fc" id="L123">      Attr attr1 = (Attr) obj1;</span>

<span class="fc" id="L125">      attr0.normalize();</span>
<span class="fc" id="L126">      attr1.normalize();</span>

<span class="fc" id="L128">      String name0 = attr0.getName();</span>
<span class="fc" id="L129">      String name1 = attr1.getName();</span>
<span class="fc" id="L130">      String prefix0 = attr0.getPrefix();</span>
<span class="fc" id="L131">      String prefix1 = attr1.getPrefix();</span>
<span class="fc" id="L132">      String localName0 = attr0.getLocalName();</span>
<span class="fc" id="L133">      String localName1 = attr1.getLocalName();</span>
<span class="fc" id="L134">      String namespaceURI0 = attr0.getNamespaceURI();</span>
<span class="fc" id="L135">      String namespaceURI1 = attr1.getNamespaceURI();</span>
<span class="fc" id="L136">      boolean definesNS0 = false;</span>
<span class="fc" id="L137">      boolean definesNS1 = false;</span>
<span class="fc" id="L138">      boolean definesDefaultNS0 = false;</span>
<span class="fc" id="L139">      boolean definesDefaultNS1 = false;</span>

      /*
       * For defualt NS definitions, the XML parser gives us
       * - prefix=null
       * - localname=null
       * - name=&quot;xmlns&quot;
       *
       * this is changed to
       * - prefix=&quot;xmlns&quot;
       * - localname=null
       * - name=&quot;xmlns&quot;
       *
       */
<span class="fc bfc" id="L153" title="All 2 branches covered.">      if (name0.equals(&quot;xmlns&quot;)) {</span>

         // must be &quot;&quot; to allow localName0.compareTo(localName1) to work
<span class="fc" id="L156">         localName0 = &quot;&quot;;</span>
<span class="fc" id="L157">         prefix0 = &quot;xmlns&quot;;</span>
<span class="fc" id="L158">         definesNS0 = true;</span>
<span class="fc" id="L159">         definesDefaultNS0 = true;</span>

<span class="fc bfc" id="L161" title="All 2 branches covered.">         if (namespaceURI0 == null) {</span>
<span class="fc" id="L162">            namespaceURI0 = &quot;http://www.w3.org/2000/xmlns/&quot;;</span>
         }
      }

<span class="fc bfc" id="L166" title="All 2 branches covered.">      if (name1.equals(&quot;xmlns&quot;)) {</span>

         // must be &quot;&quot; to allow localName0.compareTo(localName1) to work
<span class="fc" id="L169">         localName1 = &quot;&quot;;</span>
<span class="fc" id="L170">         prefix1 = &quot;xmlns&quot;;</span>
<span class="fc" id="L171">         definesNS1 = true;</span>
<span class="fc" id="L172">         definesDefaultNS1 = true;</span>

<span class="fc bfc" id="L174" title="All 2 branches covered.">         if (namespaceURI1 == null) {</span>
<span class="fc" id="L175">            namespaceURI1 = &quot;http://www.w3.org/2000/xmlns/&quot;;</span>
         }
      }

<span class="fc bfc" id="L179" title="All 2 branches covered.">      if (name0.startsWith(&quot;xmlns:&quot;)) {</span>
<span class="fc" id="L180">         prefix0 = &quot;xmlns&quot;;</span>
<span class="fc" id="L181">         localName0 = name0.substring(name0.indexOf(&quot;xmlns:&quot;)</span>
                                      + &quot;xmlns:&quot;.length());
<span class="fc" id="L183">         definesNS0 = true;</span>

<span class="fc bfc" id="L185" title="All 2 branches covered.">         if (namespaceURI0 == null) {</span>
<span class="fc" id="L186">            namespaceURI0 = &quot;http://www.w3.org/2000/xmlns/&quot;;</span>
         }
      }

<span class="fc bfc" id="L190" title="All 2 branches covered.">      if (name1.startsWith(&quot;xmlns:&quot;)) {</span>
<span class="fc" id="L191">         prefix1 = &quot;xmlns&quot;;</span>
<span class="fc" id="L192">         localName1 = name1.substring(name1.indexOf(&quot;xmlns:&quot;)</span>
                                      + &quot;xmlns:&quot;.length());
<span class="fc" id="L194">         definesNS1 = true;</span>

<span class="fc bfc" id="L196" title="All 2 branches covered.">         if (namespaceURI1 == null) {</span>
<span class="fc" id="L197">            namespaceURI1 = &quot;http://www.w3.org/2000/xmlns/&quot;;</span>
         }
      }

<span class="fc bfc" id="L201" title="All 2 branches covered.">      if (namespaceURI0 == null) {</span>
<span class="fc" id="L202">         namespaceURI0 = &quot;&quot;;</span>
<span class="fc" id="L203">         localName0 = name0;</span>
      }

<span class="fc bfc" id="L206" title="All 2 branches covered.">      if (namespaceURI1 == null) {</span>
<span class="fc" id="L207">         namespaceURI1 = &quot;&quot;;</span>
<span class="fc" id="L208">         localName1 = name1;</span>
      }

<span class="pc bpc" id="L211" title="1 of 2 branches missed.">      if (cat.isDebugEnabled()) {    // debug info</span>
<span class="fc" id="L212">         Element ownerElement = attr0.getOwnerElement();</span>
<span class="fc" id="L213">         String elementName = &quot;&quot;;</span>

         // During the test cases, there can be Attributes without containing
         // element.
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">         if (ownerElement != null) {</span>
<span class="fc" id="L218">            elementName = &quot;&lt;&quot;</span>
                          + ((Element) attr0.getOwnerElement()).getNodeName()
                          + &quot;&gt; &quot;;
         }

<span class="fc" id="L223">         cat.debug(elementName + &quot;attr0(&quot; + attr0 + &quot;): prefix(&quot; + prefix0</span>
                   + &quot;) localName(&quot; + localName0 + &quot;) name(&quot; + name0
                   + &quot;) nsURI(&quot; + namespaceURI0 + &quot;) definesNS(&quot; + definesNS0
                   + &quot;) definesDefaultNS(&quot; + definesDefaultNS0 + &quot;)&quot;);
<span class="fc" id="L227">         cat.debug(elementName + &quot;attr1(&quot; + attr1 + &quot;): prefix(&quot; + prefix1</span>
                   + &quot;) localName(&quot; + localName1 + &quot;) name(&quot; + name1
                   + &quot;) nsURI(&quot; + namespaceURI1 + &quot;) definesNS(&quot; + definesNS1
                   + &quot;) definesDefaultNS(&quot; + definesDefaultNS1 + &quot;)&quot;);
      }    // debug info

<span class="pc bpc" id="L233" title="1 of 2 branches missed.">      if (attr0 == null) {</span>
<span class="nc" id="L234">         cat.fatal(&quot;attr0 == null&quot;);</span>

<span class="nc" id="L236">         return (0);</span>
      }

<span class="pc bpc" id="L239" title="1 of 2 branches missed.">      if (attr1 == null) {</span>
<span class="nc" id="L240">         cat.fatal(&quot;attr1 == null&quot;);</span>

<span class="nc" id="L242">         return (0);</span>
      }

<span class="pc bpc" id="L245" title="3 of 4 branches missed.">      if ((localName0 == null) &amp;&amp; (name0 == null)) {</span>
<span class="nc" id="L246">         cat.fatal(&quot;localName0 == null &amp;&amp; name0 == null&quot;);</span>

<span class="nc" id="L248">         return (0);</span>
      }

<span class="pc bpc" id="L251" title="3 of 4 branches missed.">      if ((localName1 == null) &amp;&amp; (name1 == null)) {</span>
<span class="nc" id="L252">         cat.fatal(&quot;localName1 == null &amp;&amp; name1 == null&quot;);</span>

<span class="nc" id="L254">         return (0);</span>
      }

      /*
       * namespace definitions can be detected in Xerces v1.3.0 by
       *
       * boolean = namespaceURI.equals(&quot;http://www.w3.org/2000/xmlns/&quot;)
       *
       * but I don't know how stable this is. And the difference between
       * defaultNS definitions isn't checked by this either.
       *
       * In Xerces v1.3.1, it doesn't work.
       */
<span class="fc bfc" id="L267" title="All 4 branches covered.">      if (definesNS0 &amp;&amp; definesNS1) {</span>

         /*
          * - An element's namespace nodes are sorted lexicographically by
          *   local name (the default namespace node, if one exists, has no
          *   local name and is therefore lexicographically least).
          *
          */
<span class="fc" id="L275">         int result = signum(localName0.compareTo(localName1));</span>

<span class="fc" id="L277">         cat.debug(&quot;A1 returns &quot; + result);</span>

<span class="fc" id="L279">         return result;</span>
<span class="fc bfc" id="L280" title="All 4 branches covered.">      } else if (!definesNS0 &amp;&amp;!definesNS1) {</span>

         /*
          * - An element's attribute nodes are sorted lexicographically with
          *   namespace URI as the primary key and local name as the secondary
          *   key (an empty namespace URI is lexicographically least).
          *
          */
<span class="fc" id="L288">         int NScomparisonResult =</span>
            signum(namespaceURI0.compareTo(namespaceURI1));

<span class="fc bfc" id="L291" title="All 2 branches covered.">         if (NScomparisonResult != 0) {</span>
<span class="fc" id="L292">            cat.debug(&quot;A2 returns &quot; + NScomparisonResult);</span>

<span class="fc" id="L294">            return NScomparisonResult;</span>
         }

<span class="fc" id="L297">         int result = signum(localName0.compareTo(localName1));</span>

<span class="fc" id="L299">         cat.debug(&quot;A3 returns &quot; + result);</span>

<span class="fc" id="L301">         return result;</span>
<span class="pc bpc" id="L302" title="1 of 4 branches missed.">      } else if (definesNS0 &amp;&amp;!definesNS1) {</span>

         /*
          * - Namespace nodes have a lesser document order position
          *   than attribute nodes.
          *
          */
<span class="fc" id="L309">         cat.debug(&quot;A4 returns &quot; + -1);</span>

<span class="fc" id="L311">         return -1;</span>
<span class="pc bpc" id="L312" title="2 of 4 branches missed.">      } else if (!definesNS0 &amp;&amp; definesNS1) {</span>

         /*
          * - Namespace nodes have a lesser document order position
          *   than attribute nodes.
          *
          */
<span class="fc" id="L319">         cat.debug(&quot;A5 returns &quot; + 1);</span>

<span class="fc" id="L321">         return 1;</span>
      }

<span class="nc" id="L324">      cat.fatal(&quot;Oh oh, very bad...&quot;);</span>

<span class="nc" id="L326">      return 0;</span>
   }

   /**
    * Mathematical signum() function
    *
    * @param input
    * @return -1 for negative input, 1 for positive input, 0 otherwise
    */
   private static int signum(int input) {

<span class="fc bfc" id="L337" title="All 2 branches covered.">      if (input == 0) {</span>
<span class="fc" id="L338">         return 0;</span>
<span class="fc bfc" id="L339" title="All 2 branches covered.">      } else if (input &lt; 0) {</span>
<span class="fc" id="L340">         return -1;</span>
      } else {
<span class="fc" id="L342">         return 1;</span>
      }
   }

   static {
<span class="fc" id="L347">      org.apache.xml.security.Init.init();</span>
<span class="fc" id="L348">   }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>